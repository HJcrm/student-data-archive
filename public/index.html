<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒê¸°ë¶€ ë¡œë“œë§µ RAG ì‹œìŠ¤í…œ</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #10B981;
            --bg: #F9FAFB;
            --card-bg: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        header h1 { font-size: 2rem; margin-bottom: 10px; }
        header p { opacity: 0.9; }
        .stats { display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap; }
        .stat-item { background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .search-form {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .search-form h2 { margin-bottom: 20px; color: var(--primary); }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; }
        .form-group select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group select:focus { outline: none; border-color: var(--primary); }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover { background: var(--primary-light); }
        .btn:disabled { background: var(--text-light); cursor: not-allowed; }
        .form-options {
            margin: 15px 0 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        #loading { display: none; text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #result { display: none; }
        .report {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .report h1 { color: var(--primary); margin-bottom: 10px; }
        .report h2 { color: var(--text); margin: 30px 0 15px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
        .report h3 { color: var(--primary); margin: 20px 0 10px; }
        .student-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .student-card {
            background: linear-gradient(135deg, #f0f4ff, #e8f4f8);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        .student-card h3 { margin: 0 0 10px; color: var(--text); font-size: 1.1rem; }
        .student-card p { color: var(--text-light); margin: 5px 0; font-size: 0.95rem; }
        .topics ul { list-style: none; padding: 0; }
        .topics li {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid var(--secondary);
        }
        .topics .term { color: var(--primary); font-weight: 600; }
        .topics .subject { color: var(--text-light); font-size: 0.9rem; }
        .saeteuk-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .saeteuk-card h4 { color: var(--primary); margin-bottom: 10px; }
        .saeteuk-content {
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.8;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .insight-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .competency-card {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border-radius: 12px;
            padding: 18px;
            border-left: 4px solid #F59E0B;
        }
        .competency-card .card-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #B45309;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .competency-card .card-content {
            color: #78350F;
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.6;
        }
        .analysis-card {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            border-radius: 12px;
            padding: 18px;
            border-left: 4px solid #3B82F6;
        }
        .analysis-card .card-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #1E40AF;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .analysis-card .card-content {
            color: #1E3A8A;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        @media (max-width: 768px) {
            header h1 { font-size: 1.5rem; }
            .stats { flex-direction: column; gap: 10px; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“š ìƒê¸°ë¶€ ë¡œë“œë§µ RAG ì‹œìŠ¤í…œ</h1>
        <p>í•©ê²©ì ë°ì´í„° ê¸°ë°˜ ë§ì¶¤í˜• ìƒí™œê¸°ë¡ë¶€ ë¡œë“œë§µì„ ì œì•ˆí•©ë‹ˆë‹¤</p>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="stat-students">-</div>
                <div>í•©ê²©ì</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-research">-</div>
                <div>íƒêµ¬í™œë™</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-saeteuk">-</div>
                <div>ì„¸íŠ¹ ì˜ˆì‹œ</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="search-form">
            <h2>ğŸ” ë§ì¶¤ ê²€ìƒ‰</h2>
            <form id="searchForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nesin_range">ë‚´ì‹  ë“±ê¸‰ëŒ€</label>
                        <select id="nesin_range" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="1ë“±ê¸‰ëŒ€">1ë“±ê¸‰ëŒ€ (1.0 ~ 1.9)</option>
                            <option value="2ë“±ê¸‰ëŒ€">2ë“±ê¸‰ëŒ€ (2.0 ~ 2.9)</option>
                            <option value="3ë“±ê¸‰ëŒ€">3ë“±ê¸‰ëŒ€ (3.0 ~ 3.9)</option>
                            <option value="4ë“±ê¸‰ëŒ€">4ë“±ê¸‰ëŒ€ (4.0 ~ 4.9)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="school_type">í•™êµ ìœ í˜•</label>
                        <select id="school_type">
                            <option value="ì¼ë°˜ê³ ">ì¼ë°˜ê³ </option>
                            <option value="ìì‚¬ê³ ">ììœ¨í˜• ì‚¬ë¦½ê³ </option>
                            <option value="íŠ¹ëª©ê³ ">íŠ¹ìˆ˜ëª©ì ê³ </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="major_field">í¬ë§ ê³„ì—´</label>
                        <select id="major_field" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì˜ì•½">ì˜ì•½ (ì˜ì˜ˆ/ì¹˜ì˜ì˜ˆ/ì•½í•™/ê°„í˜¸)</option>
                            <option value="ê³µí•™">ê³µí•™ (ì»´í“¨í„°/ì „ì/ê¸°ê³„/ë°˜ë„ì²´)</option>
                            <option value="ìì—°">ìì—°ê³¼í•™ (ìˆ˜í•™/ë¬¼ë¦¬/í™”í•™/ìƒëª…)</option>
                            <option value="ê²½ì˜/ê²½ì œ">ê²½ì˜/ê²½ì œ</option>
                            <option value="ì‚¬íšŒ">ì‚¬íšŒê³¼í•™ (ì •ì¹˜/ì™¸êµ/ì‹¬ë¦¬)</option>
                            <option value="ì¸ë¬¸">ì¸ë¬¸ (êµ­ë¬¸/ì˜ë¬¸/ì‚¬í•™/ì² í•™)</option>
                            <option value="êµìœ¡">êµìœ¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="top_k">ê²€ìƒ‰ ìˆ˜</label>
                        <select id="top_k">
                            <option value="2">2ëª…</option>
                            <option value="3" selected>3ëª…</option>
                            <option value="5">5ëª…</option>
                        </select>
                    </div>
                </div>
                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable_formatting">
                        <span>AI í…ìŠ¤íŠ¸ êµì • (ë„ì–´ì“°ê¸° ìë™ ë³´ì •)</span>
                    </label>
                    <label class="checkbox-label" style="margin-top: 10px;">
                        <input type="checkbox" id="enable_summary" checked>
                        <span>AI ë¶„ì„ ìš”ì•½ (í•©ê²© ì„ ë°° ë¶„ì„ ì •ë¦¬)</span>
                    </label>
                </div>
                <button type="submit" class="btn" id="searchBtn">ğŸ” ë¡œë“œë§µ ìƒì„±</button>
            </form>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <p>í•©ê²©ì ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let studentsData = [];
        let researchData = [];
        let saeteukData = [];

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                const [studentsRes, researchRes, saeteukRes] = await Promise.all([
                    fetch('/data/students.json'),
                    fetch('/data/research.json'),
                    fetch('/data/saeteuk.json')
                ]);

                studentsData = await studentsRes.json();
                researchData = await researchRes.json();
                saeteukData = await saeteukRes.json();

                document.getElementById('stat-students').textContent = studentsData.length;
                document.getElementById('stat-research').textContent = researchData.length;
                document.getElementById('stat-saeteuk').textContent = saeteukData.length;
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
            }
        }

        loadData();

        // ê²€ìƒ‰ í•¨ìˆ˜
        function searchStudents(nesinRange, schoolType, majorField, topK) {
            let nesinMin = 0, nesinMax = 10;
            if (nesinRange.includes('1ë“±ê¸‰')) { nesinMin = 1.0; nesinMax = 1.99; }
            else if (nesinRange.includes('2ë“±ê¸‰')) { nesinMin = 2.0; nesinMax = 2.99; }
            else if (nesinRange.includes('3ë“±ê¸‰')) { nesinMin = 3.0; nesinMax = 3.99; }
            else if (nesinRange.includes('4ë“±ê¸‰')) { nesinMin = 4.0; nesinMax = 4.99; }

            // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Set
            const seenIds = new Set();

            let filtered = studentsData.filter(s => {
                const nesin = s.nesin_average || 0;
                return nesin >= nesinMin && nesin <= nesinMax;
            }).map(s => {
                let score = 50;
                const field = (s.major_field || '').toLowerCase();
                const searchField = majorField.toLowerCase();

                if (field === searchField || field.includes(searchField) || searchField.includes(field)) {
                    score += 50;
                }
                return { ...s, match_score: score };
            }).filter(s => s.match_score > 50)
              .sort((a, b) => b.match_score - a.match_score)
              .filter(s => {
                  // ì¤‘ë³µ í•™ìƒ ì œê±°
                  if (seenIds.has(s.id)) return false;
                  seenIds.add(s.id);
                  return true;
              })
              .slice(0, topK);

            // ê° í•™ìƒì˜ íƒêµ¬í™œë™ê³¼ ì„¸íŠ¹ ì¶”ê°€
            filtered.forEach(student => {
                student.research = researchData.filter(r => r.student_id === student.id);
                student.saeteuk = saeteukData.filter(s => s.student_id === student.id).slice(0, 3);
            });

            return filtered;
        }

        // ì„¸íŠ¹ ë‚´ìš© íŒŒì‹± (ì—­ëŸ‰, ë¶„ì„ ë¶„ë¦¬)
        function parseSaeteukContent(content) {
            if (!content) return { main: '', competency: '', analysis: '' };

            let main = content;
            let competency = '';
            let analysis = '';

            // "ë³´ì—¬ì£¼ê³ ì‹¶ì€ì—­ëŸ‰" ë˜ëŠ” "ë³´ì—¬ì£¼ê³  ì‹¶ì€ ì—­ëŸ‰" íŒ¨í„´ ì°¾ê¸°
            const competencyPatterns = [
                /ë³´ì—¬ì£¼ê³ \s*ì‹¶ì€\s*ì—­ëŸ‰\s*[:ï¼š]\s*/i,
                /ë³´ì—¬ì£¼ê³ ì‹¶ì€ì—­ëŸ‰\s*[:ï¼š]\s*/i
            ];

            // "í•©ê²©ì„ ë°°ì˜ìƒê¸°ë¶€ë¶„ì„" ë˜ëŠ” "í•©ê²© ì„ ë°°ì˜ ìƒê¸°ë¶€ ë¶„ì„" íŒ¨í„´ ì°¾ê¸°
            const analysisPatterns = [
                /í•©ê²©\s*ì„ ë°°ì˜\s*ìƒê¸°ë¶€\s*ë¶„ì„\s*[:ï¼š]\s*/i,
                /í•©ê²©ì„ ë°°ì˜ìƒê¸°ë¶€ë¶„ì„\s*[:ï¼š]\s*/i
            ];

            // ì—­ëŸ‰ ì¶”ì¶œ
            for (const pattern of competencyPatterns) {
                const match = content.match(pattern);
                if (match) {
                    const startIdx = match.index;
                    const afterMatch = content.substring(startIdx + match[0].length);

                    // ë‹¤ìŒ ì„¹ì…˜ê¹Œì§€ ë˜ëŠ” ëê¹Œì§€
                    let endIdx = afterMatch.length;
                    for (const ap of analysisPatterns) {
                        const analysisMatch = afterMatch.match(ap);
                        if (analysisMatch && analysisMatch.index < endIdx) {
                            endIdx = analysisMatch.index;
                        }
                    }

                    competency = afterMatch.substring(0, endIdx).trim();
                    main = content.substring(0, startIdx).trim();
                    break;
                }
            }

            // ë¶„ì„ ì¶”ì¶œ
            for (const pattern of analysisPatterns) {
                const match = content.match(pattern);
                if (match) {
                    const startIdx = match.index;
                    analysis = content.substring(startIdx + match[0].length).trim();

                    // mainì—ì„œ ë¶„ì„ ë¶€ë¶„ ì œê±°
                    if (main.includes(content.substring(startIdx))) {
                        main = main.substring(0, main.indexOf(content.substring(startIdx, startIdx + 20))).trim();
                    }
                    break;
                }
            }

            // ì—­ëŸ‰ì—ì„œ ë¶„ì„ ë¶€ë¶„ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì œê±°
            for (const pattern of analysisPatterns) {
                const match = competency.match(pattern);
                if (match) {
                    competency = competency.substring(0, match.index).trim();
                    break;
                }
            }

            return { main, competency, analysis };
        }

        // ê²°ê³¼ HTML ìƒì„±
        function generateResultHTML(query, students) {
            if (students.length === 0) {
                return `
                    <div class="report">
                        <h1>ğŸ˜¢ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</h1>
                        <p>ì¡°ê±´ì— ë§ëŠ” í•©ê²© ì‚¬ë¡€ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
            }

            let html = `
                <div class="report">
                    <h1>ğŸ“š ë§ì¶¤ ìƒê¸°ë¶€ ë¡œë“œë§µ</h1>
                    <p>ê²€ìƒ‰ ì¡°ê±´: ${query.nesin_range} | ${query.school_type} | ${query.major_field}</p>

                    <h2>ğŸ¯ ìœ ì‚¬ í•©ê²© ì‚¬ë¡€ (${students.length}ëª…)</h2>
                    <div class="student-cards">
            `;

            students.forEach(s => {
                html += `
                    <div class="student-card">
                        <h3>${s.final_university || 'ë¯¸ìƒ'} ${s.final_department || ''}</h3>
                        <p>ë‚´ì‹  í‰ê· : ${s.nesin_average || '?'}ë“±ê¸‰</p>
                        <p>í•™êµ ìœ í˜•: ${s.school_type || 'ì¼ë°˜ê³ '}</p>
                        <p>ê³„ì—´: ${s.major_field || '?'}</p>
                    </div>
                `;
            });

            html += '</div><h2>ğŸ“ ì¶”ì²œ íƒêµ¬ ì£¼ì œ</h2>';

            students.forEach(s => {
                if (s.research && s.research.length > 0) {
                    html += `<h3>${s.final_university} í•©ê²©ìƒì˜ íƒêµ¬í™œë™</h3><div class="topics"><ul>`;
                    s.research.forEach(r => {
                        html += `
                            <li>
                                <span class="term">[${r.term || ''}]</span>
                                <span class="subject">${r.subject || ''}</span><br>
                                ${r.title || ''}
                            </li>
                        `;
                    });
                    html += '</ul></div>';
                }
            });

            html += '<h2>âœï¸ ì„¸íŠ¹ ì˜ˆì‹œ</h2>';

            students.forEach(s => {
                if (s.saeteuk && s.saeteuk.length > 0) {
                    html += `<h3>${s.final_university} í•©ê²©ìƒ</h3>`;
                    s.saeteuk.forEach(st => {
                        // ì´ë¯¸ íŒŒì‹±ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ íŒŒì‹±
                        const parsed = st.parsed || parseSaeteukContent(st.content || '');

                        html += `<div class="saeteuk-card">`;
                        html += `<h4>${st.subject || 'ê³¼ëª© ë¯¸ìƒ'}</h4>`;

                        // ì—­ëŸ‰ê³¼ ë¶„ì„ì´ ìˆìœ¼ë©´ ìƒë‹¨ì— ëˆˆì— ë„ê²Œ í‘œì‹œ
                        if (parsed.competency || parsed.analysis) {
                            html += `<div class="insight-box">`;
                            if (parsed.competency) {
                                html += `
                                    <div class="competency-card">
                                        <div class="card-label">ğŸ’ª ë³´ì—¬ì£¼ê³  ì‹¶ì€ ì—­ëŸ‰</div>
                                        <div class="card-content">${parsed.competency}</div>
                                    </div>
                                `;
                            }
                            if (parsed.analysis) {
                                html += `
                                    <div class="analysis-card">
                                        <div class="card-label">ğŸ“ í•©ê²© ì„ ë°°ì˜ ìƒê¸°ë¶€ ë¶„ì„</div>
                                        <div class="card-content">${parsed.analysis}</div>
                                    </div>
                                `;
                            }
                            html += `</div>`;
                        }

                        // ë©”ì¸ ì„¸íŠ¹ ë‚´ìš©
                        html += `<div class="saeteuk-content">${parsed.main}</div>`;
                        html += `</div>`;
                    });
                }
            });

            html += '</div>';
            return html;
        }

        // í…ìŠ¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ (êµì • ë˜ëŠ” ìš”ì•½)
        async function processText(text, mode = 'format') {
            try {
                const response = await fetch('/api/format', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, mode })
                });
                const data = await response.json();
                return data.success ? data.result : text;
            } catch (e) {
                console.error('ì²˜ë¦¬ ì˜¤ë¥˜:', e);
                return text;
            }
        }

        // í¼ ì œì¶œ
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const query = {
                nesin_range: document.getElementById('nesin_range').value,
                school_type: document.getElementById('school_type').value,
                major_field: document.getElementById('major_field').value,
                top_k: parseInt(document.getElementById('top_k').value)
            };
            const enableFormatting = document.getElementById('enable_formatting').checked;
            const enableSummary = document.getElementById('enable_summary').checked;

            if (!query.nesin_range || !query.major_field) {
                alert('ë‚´ì‹  ë“±ê¸‰ëŒ€ì™€ í¬ë§ ê³„ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            let loadingText = 'í•©ê²©ì ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            if (enableFormatting || enableSummary) {
                loadingText = 'AIê°€ í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            }
            document.getElementById('loading').querySelector('p').textContent = loadingText;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;

            try {
                const results = searchStudents(query.nesin_range, query.school_type, query.major_field, query.top_k);

                // ê° ì„¸íŠ¹ì— ëŒ€í•´ íŒŒì‹± ë° AI ì²˜ë¦¬ ì ìš©
                for (const student of results) {
                    if (student.saeteuk) {
                        for (const st of student.saeteuk) {
                            if (st.content) {
                                // ë¨¼ì € íŒŒì‹±
                                const parsed = parseSaeteukContent(st.content);

                                // í…ìŠ¤íŠ¸ êµì • ì ìš©
                                if (enableFormatting && parsed.main) {
                                    parsed.main = await processText(parsed.main, 'format');
                                }

                                // ë¶„ì„ ìš”ì•½ ì ìš©
                                if (enableSummary && parsed.analysis) {
                                    parsed.analysis = await processText(parsed.analysis, 'summarize');
                                }

                                // íŒŒì‹±ëœ ê²°ê³¼ ì €ì¥
                                st.parsed = parsed;
                            }
                        }
                    }
                }

                const html = generateResultHTML(query, results);
                document.getElementById('result').innerHTML = html;
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
